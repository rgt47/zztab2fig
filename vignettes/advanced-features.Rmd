---
title: "Advanced Features: zztab2fig"
author: "Ronald G. Thomas"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Features: zztab2fig}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center"
)

has_latex <- nzchar(Sys.which("pdflatex")) && nzchar(Sys.which("pdfcrop"))

output_dir <- tempdir()

include_table <- function(filename) {
  pdf_path <- file.path(output_dir, paste0(filename, "_cropped.pdf"))
  if (!file.exists(pdf_path)) return(invisible(NULL))
  png_path <- sub("\\.pdf$", ".png", pdf_path)
  convert_pdf_to_png(pdf_path, png_path, dpi = 150)
  knitr::include_graphics(png_path)
}
```

zztab2fig v0.2.0 introduced substantial enhancements for publication-quality
table formatting. This vignette demonstrates the advanced capabilities that
distinguish zztab2fig from simpler table packages:

- **Table footnotes** with multiple notation types (general, numbered,
  alphabetic, symbol)
- **Spanning headers** for grouped column layouts common in clinical tables
- **Multi-row cells** for hierarchical data presentation
- **Decimal alignment** via siunitx integration
- **LaTeX figure placement helpers** for precise document integration

These features address requirements frequently encountered in medical, scientific,
and social science publications.

## Setup

```{r load}
library(zztab2fig)
```

---

## 1. Table Footnotes

Professional tables often require footnotes to explain abbreviations, provide
context, or indicate significance levels. zztab2fig provides full footnote
support via the `t2f_footnote()` function.

### Basic Footnotes

```{r footnotes-basic, eval=has_latex}
results <- data.frame(
  Variable = c("Age", "BMI", "Systolic BP", "HbA1c"),
  Treatment = c("52.3 (8.2)", "28.1 (4.3)", "142.5 (18.3)", "7.2 (1.1)"),
  Control = c("51.8 (7.9)", "27.9 (4.1)", "140.2 (17.1)", "7.4 (1.2)"),
  `P-value` = c("0.542", "0.631", "0.048", "0.089"),
  check.names = FALSE
)

fn <- t2f_footnote(
  general = c(
    "Values are mean (SD) unless otherwise noted.",
    "BMI = body mass index; BP = blood pressure; HbA1c = hemoglobin A1c."
  )
)

t2f(results,
    filename = "baseline_characteristics",
    sub_dir = output_dir,
    caption = "Baseline Characteristics by Treatment Group",
    footnote = fn,
    theme = "nejm")
```

```{r footnotes-basic-display, echo=FALSE, eval=has_latex, out.width="80%"}
include_table("baseline_characteristics")
```

### Multiple Footnote Types (APA Style)

APA format requires specific footnote organization: general notes, then
specific notes, then probability notes.

```{r footnotes-apa, eval=has_latex}
anova_results <- data.frame(
  Source = c("Treatment", "Time", "Treatment x Time", "Error"),
  SS = c(245.32, 189.45, 52.18, 1024.56),
  df = c(2, 3, 6, 108),
  MS = c(122.66, 63.15, 8.70, 9.49),
  F = c(12.93, 6.66, 0.92, NA),
  p = c("<0.001", "0.002", "0.485", NA)
)

anova_results$F[1] <- t2f_mark("12.93", 1, "symbol")
anova_results$F[2] <- t2f_mark("6.66", 2, "symbol")

fn_apa <- t2f_footnote(
  general = "SS = sum of squares; MS = mean square.",
  symbol = c("p < .001", "p < .01"),
  title_general = "Note.",
  title_symbol = NULL,
  footnote_as_chunk = TRUE
)

t2f(anova_results,
    filename = "anova_table",
    sub_dir = output_dir,
    caption = "Analysis of Variance Results",
    footnote = fn_apa,
    theme = "apa")
```

```{r footnotes-apa-display, echo=FALSE, eval=has_latex, out.width="80%"}
include_table("anova_table")
```

### Numbered Footnotes for Specific Cells

```{r footnotes-numbered, eval=has_latex}
endpoints <- data.frame(
  Endpoint = c("Primary: ADAS-Cog14", "Secondary: CDR-SB",
               "Secondary: ADCS-ADL", "Exploratory: Brain Volume"),
  Difference = c("-0.45", "-0.21", "0.18", "-2.1%"),
  CI = c("(-0.82, -0.08)", "(-0.39, -0.03)", "(-0.15, 0.51)",
         "(-3.8%, -0.4%)"),
  P = c("0.018", "0.024", "0.285", "0.016")
)

endpoints$Endpoint[1] <- t2f_mark(endpoints$Endpoint[1], 1, "number")
endpoints$Difference[4] <- t2f_mark(endpoints$Difference[4], 2, "number")

fn_numbered <- t2f_footnote(
  number = c(
    "Co-primary endpoint with CDR-SB.",
    "Percentage change from baseline in whole brain volume."
  )
)

t2f(endpoints,
    filename = "endpoints_table",
    sub_dir = output_dir,
    caption = "Efficacy Endpoints at Week 78",
    footnote = fn_numbered,
    theme = "nejm")
```

```{r footnotes-numbered-display, echo=FALSE, eval=has_latex, out.width="80%"}
include_table("endpoints_table")
```

---

## 2. Spanning Headers (Grouped Columns)

Spanning headers group related columns under a common label, essential for
complex tables comparing multiple conditions or timepoints.

### Basic Spanning Header

```{r header-basic, eval=has_latex}
comparison <- data.frame(
  Measure = c("Score A", "Score B", "Score C"),
  T_Mean = c(23.4, 18.7, 42.1),
  T_SD = c(5.2, 3.8, 8.9),
  C_Mean = c(21.2, 19.1, 38.5),
  C_SD = c(4.9, 4.1, 9.2)
)
names(comparison) <- c("Measure", "Mean", "SD", "Mean", "SD")

hdr <- t2f_header_above(
  " " = 1,
  "Treatment" = 2,

  "Control" = 2
)

t2f(comparison,
    filename = "treatment_comparison",
    sub_dir = output_dir,
    caption = "Treatment vs Control Outcomes",
    header_above = hdr)
```

```{r header-basic-display, echo=FALSE, eval=has_latex, out.width="70%"}
include_table("treatment_comparison")
```

### Multiple Header Rows

```{r header-multiple, eval=has_latex}
longitudinal <- data.frame(
  Variable = c("Cognitive", "Functional", "Behavioral"),
  W12_T = c(-1.2, -0.8, -0.3),
  W12_C = c(-0.9, -0.6, -0.2),
  W24_T = c(-2.1, -1.5, -0.5),
  W24_C = c(-1.4, -1.0, -0.3),
  W52_T = c(-3.8, -2.8, -0.9),
  W52_C = c(-2.2, -1.8, -0.5)
)
names(longitudinal) <- c("Domain", "Trt", "Ctrl", "Trt", "Ctrl", "Trt", "Ctrl")

headers <- list(
  t2f_header_above(
    " " = 1,
    "Week 12" = 2,
    "Week 24" = 2,
    "Week 52" = 2
  ),
  t2f_header_above(
    " " = 1,
    "Change from Baseline" = 6,
    line = FALSE
  )
)

t2f(longitudinal,
    filename = "longitudinal_outcomes",
    sub_dir = output_dir,
    caption = "Change from Baseline by Timepoint",
    header_above = headers,
    theme = "nature")
```

```{r header-multiple-display, echo=FALSE, eval=has_latex, out.width="80%"}
include_table("longitudinal_outcomes")
```

---

## 3. Multi-Row Cells (Collapsed Rows)

When data has hierarchical structure, collapsing repeated values into
multi-row cells improves readability.

### Basic Row Collapsing

```{r collapse-basic, eval=has_latex}
subgroup <- data.frame(
  Category = c("Age", "Age", "Sex", "Sex", "Race", "Race", "Race"),
  Subgroup = c("<65", ">=65", "Male", "Female", "White", "Black", "Asian"),
  N = c(245, 189, 218, 216, 312, 67, 55),
  Effect = c(0.42, 0.38, 0.41, 0.39, 0.40, 0.44, 0.36),
  CI = c("(0.28, 0.56)", "(0.22, 0.54)", "(0.27, 0.55)", "(0.24, 0.54)",
         "(0.28, 0.52)", "(0.24, 0.64)", "(0.14, 0.58)")
)

t2f(subgroup,
    filename = "subgroup_analysis",
    sub_dir = output_dir,
    caption = "Subgroup Analysis of Treatment Effect",
    collapse_rows = t2f_collapse_rows(
      columns = 1,
      valign = "top",
      latex_hline = "major"
    ))
```

```{r collapse-basic-display, echo=FALSE, eval=has_latex, out.width="70%"}
include_table("subgroup_analysis")
```

### Multiple Column Collapse

```{r collapse-multiple, eval=has_latex}
adverse_events <- data.frame(
  System = c(rep("Nervous System", 3), rep("Gastrointestinal", 3),
             rep("General", 2)),
  Category = c("Headache", "Dizziness", "Somnolence",
               "Nausea", "Diarrhea", "Vomiting",
               "Fatigue", "Pyrexia"),
  Treatment = c(45, 32, 18, 28, 22, 15, 38, 12),
  Placebo = c(41, 28, 14, 25, 19, 12, 35, 10)
)

t2f(adverse_events,
    filename = "adverse_events",
    sub_dir = output_dir,
    caption = "Adverse Events by System Organ Class",
    collapse_rows = t2f_collapse_rows(
      columns = 1,
      valign = "middle",
      latex_hline = "major"
    ),
    theme = "nejm")
```

```{r collapse-multiple-display, echo=FALSE, eval=has_latex, out.width="70%"}
include_table("adverse_events")
```

---

## 4. Decimal Alignment

Proper decimal alignment makes numeric tables easier to read and compare.
zztab2fig provides siunitx integration for precise alignment.

### Basic Decimal Alignment

```{r decimal-basic, eval=has_latex}
stats <- data.frame(
  Parameter = c("Mean", "Median", "SD", "Min", "Max"),
  Treatment = c(127.45, 125.00, 18.234, 89.1, 178.92),
  Control = c(124.82, 123.50, 17.891, 91.3, 172.45)
)

t2f(stats,
    filename = "summary_stats",
    sub_dir = output_dir,
    caption = "Summary Statistics by Group",
    align = list(
      "l",
      t2f_decimal(3, 2),
      t2f_decimal(3, 2)
    ))
```

```{r decimal-basic-display, echo=FALSE, eval=has_latex, out.width="60%"}
include_table("summary_stats")
```

### Mixed Alignment with Custom Formats

```{r decimal-custom, eval=has_latex}
coefs <- data.frame(
  Term = c("(Intercept)", "Age", "Sex (Male)", "BMI", "Smoking"),
  Estimate = c(2.345, 0.082, -0.451, 0.123, 0.892),
  SE = c(0.234, 0.015, 0.198, 0.028, 0.245),
  t = c(10.02, 5.47, -2.28, 4.39, 3.64),
  p = c("<0.001", "<0.001", "0.024", "<0.001", "<0.001")
)

t2f(coefs,
    filename = "regression_coefs",
    sub_dir = output_dir,
    caption = "Regression Coefficients",
    align = list(
      "l",
      t2f_siunitx(table_format = "1.3"),
      t2f_siunitx(table_format = "1.3"),
      t2f_siunitx(table_format = "2.2"),
      "r"
    ))
```

```{r decimal-custom-display, echo=FALSE, eval=has_latex, out.width="70%"}
include_table("regression_coefs")
```

---

## 5. Short Captions

For documents with a List of Tables, short captions provide concise entries
while the full caption remains with the table.

```{r short-caption, eval=has_latex}
detailed_results <- data.frame(
  Outcome = c("Primary", "Secondary 1", "Secondary 2"),
  Estimate = c(0.45, 0.32, 0.28),
  CI = c("(0.22, 0.68)", "(0.15, 0.49)", "(0.08, 0.48)"),
  P = c("0.001", "0.012", "0.042")
)

t2f(detailed_results,
    filename = "efficacy_results",
    sub_dir = output_dir,
    caption = paste(
      "Efficacy Results from the Phase 3 Randomized Controlled Trial",
      "of Drug X versus Placebo in Patients with Moderate-to-Severe",
      "Condition Y (Modified Intention-to-Treat Population)"
    ),
    caption_short = "Efficacy Results from Phase 3 Trial",
    label = "tab:efficacy")
```

```{r short-caption-display, echo=FALSE, eval=has_latex, out.width="60%"}
include_table("efficacy_results")
```

---

## 6. Combining Advanced Features

Real-world tables often require multiple advanced features simultaneously.

### Publication-Ready Clinical Table

```{r combined-clinical, eval=has_latex}
clinical <- data.frame(
  Endpoint = c("ADAS-Cog14", "ADAS-Cog14", "CDR-SB", "CDR-SB"),
  Timepoint = c("Week 52", "Week 78", "Week 52", "Week 78"),
  N_T = c(423, 398, 423, 398),
  N_C = c(421, 395, 421, 395),
  Diff = c(-0.31, -0.45, -0.15, -0.21),
  CI_Low = c(-0.58, -0.82, -0.28, -0.39),
  CI_High = c(-0.04, -0.08, -0.02, -0.03),
  P = c("0.024", "0.018", "0.025", "0.024")
)

clinical$Diff <- sapply(seq_len(nrow(clinical)), function(i) {
  if (as.numeric(clinical$P[i]) < 0.05) {
    t2f_mark(as.character(clinical$Diff[i]), 1, "symbol")
  } else {
    as.character(clinical$Diff[i])
  }
})

hdr <- t2f_header_above(
  " " = 2,
  "N" = 2,
  "Treatment Effect" = 4
)

fn <- t2f_footnote(
  general = "Difference is treatment minus placebo (negative favors treatment).",
  symbol = "p < 0.05 vs placebo.",
  title_general = "Note:"
)

t2f(clinical,
    filename = "clinical_efficacy",
    sub_dir = output_dir,
    caption = "Efficacy Outcomes in the Modified ITT Population",
    caption_short = "Efficacy Outcomes",
    label = "tab:efficacy",
    header_above = hdr,
    footnote = fn,
    collapse_rows = t2f_collapse_rows(columns = 1, valign = "top"),
    theme = "nejm")
```

```{r combined-clinical-display, echo=FALSE, eval=has_latex, out.width="90%"}
include_table("clinical_efficacy")
```

---

## 7. Inline Tables for R Markdown

The `t2f_inline()` function provides a streamlined workflow for including
tables directly in R Markdown documents without LaTeX float positioning.

### Basic Inline Usage

```{r inline-basic, eval=FALSE}
model <- lm(mpg ~ cyl + hp + wt, data = mtcars)

t2f_inline(model,
           width = "3in",
           align = "left")
```

The table appears exactly where the code chunk is placed, rather than being
positioned by LaTeX's float algorithm.

### Inline with Caption and Cross-Reference

```{r inline-caption, eval=FALSE}
t2f_inline(model,
           width = "3in",
           align = "left",
           caption = "Linear Model Results",
           label = "tab:model",
           caption_position = "above")
```

Key parameters:

- `caption`: Table caption using `\captionof{table}{...}` (no float required)
- `label`: LaTeX label for cross-referencing with `\ref{tab:model}`
- `caption_position`: "above" (default, standard for tables) or "below"
- `width`/`height`: Figure dimensions in LaTeX units
- `align`: "left", "center", or "right"

**Note**: When using captions, add to your R Markdown YAML:

```yaml
header-includes:
  - \usepackage{caption}
```

### Convenience Function for Models

`t2f_coef()` provides sensible defaults for coefficient tables:

```{r coef-example, eval=FALSE}
model <- lm(mpg ~ cyl + hp + wt, data = mtcars)
t2f_coef(model, caption = "Model Coefficients", label = "tab:coef")
```

Defaults: `width = "3in"`, `align = "left"`, `caption_position = "above"`

---

## 8. Dependency Checking

zztab2fig requires LaTeX tools (`pdflatex`, `pdfcrop`) to generate PDFs. Helper
functions assist with checking and installing these dependencies.

### Check All Dependencies

```{r check-deps, eval=FALSE}
check_latex_deps()
```

Output shows status of each component:

```
Checking LaTeX dependencies for zztab2fig...

pdflatex: OK
pdfcrop:  OK

All dependencies available. zztab2fig is ready to use.
```

### Install pdfcrop via TinyTeX

If pdfcrop is missing and you use TinyTeX:

```{r ensure-pdfcrop, eval=FALSE}
ensure_pdfcrop(auto_install = TRUE)
```
This checks for the `tinytex` R package and TinyTeX distribution, then runs
`tinytex::tlmgr_install("pdfcrop")` if available.

### Check pdflatex

```{r ensure-pdflatex, eval=FALSE}
ensure_pdflatex()
```

Provides installation guidance if pdflatex is not found.

---

## 9. LaTeX Figure Placement Helpers

After generating tables, use these helpers to include them in LaTeX documents
with precise placement control. These functions output raw LaTeX code for use
in `.Rnw` or `.tex` documents.

### Standard Figure Float

The `t2f_include()` function wraps the PDF in a figure environment:

```{r include-figure-code, eval=FALSE}
t2f(mtcars[1:5, 1:4], filename = "demo_table", sub_dir = "tables")

t2f_include("tables/demo_table",
            caption = "Motor Trend Car Data (First 5 Rows)",
            label = "fig:mtcars",
            position = "htbp")
```

**Generated LaTeX:**

```latex
\begin{figure}[htbp]
\centering
\includegraphics{tables/demo_table_cropped.pdf}
\caption{Motor Trend Car Data (First 5 Rows)}
\label{fig:mtcars}
\end{figure}
```

### Exact Placement (No Floating)

For precise placement without LaTeX float behavior:

```{r include-inline-code, eval=FALSE}
t2f_include_inline("tables/demo_table",
                   width = "0.8\\textwidth",
                   vspace = "1em")
```

### Side-by-Side Tables

```{r include-sidebyside-code, eval=FALSE}
t2f(mtcars[1:5, 1:3], filename = "table_a", sub_dir = "tables")
t2f(mtcars[1:5, 4:6], filename = "table_b", sub_dir = "tables")

t2f_include_sidebyside(
  "tables/table_a", "tables/table_b",
  caption1 = "(a) Performance",
  caption2 = "(b) Design",
  main_caption = "Motor Trend Car Data by Category",
  main_label = "fig:mtcars_combined"
)
```

### Margin Placement

For documents with wide margins (Tufte style, etc.):

```{r include-margin-code, eval=FALSE}
t2f_include_margin("tables/demo_table",
                   caption = "Summary",
                   method = "sidenotes")
```

### Text Wrapping

```{r include-wrap-code, eval=FALSE}
t2f_include_wrap("tables/demo_table",
                 placement = "r",
                 wrap_width = "0.45\\textwidth",
                 caption = "Car data summary")
```

---

## 10. Cross-References

Generate LaTeX cross-reference commands from R:

```{r crossref-code, eval=FALSE}
cat("As shown in ")
t2f_ref("fig:mtcars")
cat(", the fuel efficiency varies considerably.")

ref_text <- sprintf("Results are presented in %s.",
                    t2f_ref("tab:efficacy", cat = FALSE))
cat(ref_text)
```

---

## Summary

zztab2fig v0.2.0 provides comprehensive support for publication-quality tables:

- **Inline tables**: `t2f_inline()` for R Markdown without float positioning
- **Caption control**: `caption_position` (above/below) with `\captionof`
- **Footnotes**: General, numbered, alphabetic, and symbol notation
- **Spanning headers**: Single or multiple levels of grouped columns
- **Multi-row cells**: Automatic collapsing of hierarchical data
- **Decimal alignment**: siunitx integration for precise number formatting
- **Short captions**: For List of Tables entries
- **Figure placement**: Float, inline, margin, wrap, and side-by-side options
- **Dependency helpers**: `check_latex_deps()`, `ensure_pdfcrop()`

These features can be combined to create tables meeting the most demanding
journal requirements while maintaining a clean R-based workflow.
